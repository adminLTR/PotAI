version: '3.8'

services:
  # ==================== DATABASES ====================
  
  # Base de datos para Auth Service
  auth-db:
    image: mysql:8.0
    container_name: potai-auth-db
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
      MYSQL_DATABASE: potai_auth
      MYSQL_USER: ${MYSQL_USER:-potai}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-potaipass}
    ports:
      - "3307:3306"
    volumes:
      - auth-db-data:/var/lib/mysql
    networks:
      - potai-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Base de datos para Plants Service
  plants-db:
    image: mysql:8.0
    container_name: potai-plants-db
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
      MYSQL_DATABASE: potai_plants
      MYSQL_USER: ${MYSQL_USER:-potai}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-potaipass}
    ports:
      - "3308:3306"
    volumes:
      - plants-db-data:/var/lib/mysql
    networks:
      - potai-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Base de datos para Pots Service
  pots-db:
    image: mysql:8.0
    container_name: potai-pots-db
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
      MYSQL_DATABASE: potai_pots
      MYSQL_USER: ${MYSQL_USER:-potai}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-potaipass}
    ports:
      - "3309:3306"
    volumes:
      - pots-db-data:/var/lib/mysql
    networks:
      - potai-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Base de datos para IoT Service
  iot-db:
    image: mysql:8.0
    container_name: potai-iot-db
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
      MYSQL_DATABASE: potai_iot
      MYSQL_USER: ${MYSQL_USER:-potai}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-potaipass}
    ports:
      - "3310:3306"
    volumes:
      - iot-db-data:/var/lib/mysql
    networks:
      - potai-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Base de datos para Species Service
  species-db:
    image: mysql:8.0
    container_name: potai-species-db
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
      MYSQL_DATABASE: potai_species
      MYSQL_USER: ${MYSQL_USER:-potai}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-potaipass}
    ports:
      - "3311:3306"
    volumes:
      - species-db-data:/var/lib/mysql
    networks:
      - potai-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis para sesiones y cache
  redis:
    image: redis:7-alpine
    container_name: potai-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - potai-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ==================== MICROSERVICES ====================

  # Auth Service
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: potai-auth-service
    environment:
      NODE_ENV: development
      PORT: 3001
      DATABASE_URL: mysql://root:rootpass@auth-db:3306/potai_auth
      SHADOW_DATABASE_URL: mysql://root:rootpass@auth-db:3306/potai_auth_shadow
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-this}
      JWT_EXPIRES_IN: 2h
    ports:
      - "3001:3001"
    depends_on:
      auth-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./auth-service:/app
      - /app/node_modules
    networks:
      - potai-network
    command: npm run dev

  # Plants Service
  plants-service:
    build:
      context: ./plants-service
      dockerfile: Dockerfile
    container_name: potai-plants-service
    environment:
      NODE_ENV: development
      PORT: 3002
      DATABASE_URL: mysql://root:rootpass@plants-db:3306/potai_plants
      SHADOW_DATABASE_URL: mysql://root:rootpass@plants-db:3306/potai_plants_shadow
      AUTH_SERVICE_URL: http://auth-service:3001
      MEDIA_SERVICE_URL: http://media-service:3005
      SPECIES_SERVICE_URL: http://species-service:3006
    ports:
      - "3002:3002"
    depends_on:
      plants-db:
        condition: service_healthy
    volumes:
      - ./plants-service:/app
      - /app/node_modules
    networks:
      - potai-network
    command: npm run dev

  # Pots Service
  pots-service:
    build:
      context: ./pots-service
      dockerfile: Dockerfile
    container_name: potai-pots-service
    environment:
      NODE_ENV: development
      PORT: 3003
      DATABASE_URL: mysql://root:rootpass@pots-db:3306/potai_pots
      SHADOW_DATABASE_URL: mysql://root:rootpass@pots-db:3306/potai_pots_shadow
      AUTH_SERVICE_URL: http://auth-service:3001
    ports:
      - "3003:3003"
    depends_on:
      pots-db:
        condition: service_healthy
    volumes:
      - ./pots-service:/app
      - /app/node_modules
    networks:
      - potai-network
    command: npm run dev

  # IoT Service
  iot-service:
    build:
      context: ./iot-service
      dockerfile: Dockerfile
    container_name: potai-iot-service
    environment:
      NODE_ENV: development
      PORT: 3004
      DATABASE_URL: mysql://root:rootpass@iot-db:3306/potai_iot
      SHADOW_DATABASE_URL: mysql://root:rootpass@iot-db:3306/potai_iot_shadow
      ML_SERVICE_URL: http://ml-service:5000
      PLANTS_SERVICE_URL: http://plants-service:3002
      IOT_API_KEY: ${IOT_API_KEY:-potai-iot-secret-key}
    ports:
      - "3004:3004"
    depends_on:
      iot-db:
        condition: service_healthy
    volumes:
      - ./iot-service:/app
      - /app/node_modules
    networks:
      - potai-network
    command: npm run dev

  # Media Service
  media-service:
    build:
      context: ./media-service
      dockerfile: Dockerfile
    container_name: potai-media-service
    environment:
      NODE_ENV: development
      PORT: 3005
      UPLOAD_DIR: /app/uploads
      MAX_FILE_SIZE: 10485760
    ports:
      - "3005:3005"
    volumes:
      - ./media-service:/app
      - /app/node_modules
      - media-uploads:/app/uploads
    networks:
      - potai-network
    command: npm run dev

  # Species Service
  species-service:
    build:
      context: ./species-service
      dockerfile: Dockerfile
    container_name: potai-species-service
    environment:
      NODE_ENV: development
      PORT: 3006
      DATABASE_URL: mysql://root:rootpass@species-db:3306/potai_species
      SHADOW_DATABASE_URL: mysql://root:rootpass@species-db:3306/potai_species_shadow
    ports:
      - "3006:3006"
    depends_on:
      species-db:
        condition: service_healthy
    volumes:
      - ./species-service:/app
      - /app/node_modules
    networks:
      - potai-network
    command: npm run dev

  # ML Service (Python/Flask)
  ml-service:
    build:
      context: ./ml-service
      dockerfile: Dockerfile
    container_name: potai-ml-service
    environment:
      FLASK_ENV: development
      FLASK_APP: app.py
      PORT: 5000
      SPECIES_SERVICE_URL: http://species-service:3006
    ports:
      - "5000:5000"
    volumes:
      - ./ml-service:/app
      - ./ml-service/models:/app/models
    networks:
      - potai-network
    command: python app.py

  # API Gateway
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: potai-gateway
    environment:
      NODE_ENV: development
      PORT: 8080
      AUTH_SERVICE_URL: http://auth-service:3001
      PLANTS_SERVICE_URL: http://plants-service:3002
      POTS_SERVICE_URL: http://pots-service:3003
      IOT_SERVICE_URL: http://iot-service:3004
      MEDIA_SERVICE_URL: http://media-service:3005
      SPECIES_SERVICE_URL: http://species-service:3006
      ML_SERVICE_URL: http://ml-service:5000
    ports:
      - "8080:8080"
    depends_on:
      - auth-service
      - plants-service
      - pots-service
      - iot-service
      - media-service
      - species-service
      - ml-service
    volumes:
      - ./gateway:/app
      - /app/node_modules
    networks:
      - potai-network
    command: npm run dev

  # Frontend (Nginx serving static files)
  frontend:
    image: nginx:alpine
    container_name: potai-frontend
    ports:
      - "80:80"
    volumes:
      - ../frontend:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - potai-network
    depends_on:
      - gateway

networks:
  potai-network:
    driver: bridge

volumes:
  auth-db-data:
  plants-db-data:
  pots-db-data:
  iot-db-data:
  species-db-data:
  redis-data:
  media-uploads:
